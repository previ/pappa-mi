(function(a){a.ajaxComboBox=function(b,c,d,e){function bs(a,b){if(!d.sub_info)return;bp();bo();bq();br();if(b==null){b=H.children("li").index(a)}I.children("dl").hide();if(b>-1){var c=0;if(G.css("display")!="none")c+=w;c+=x+y*b;var e=z;c+="px";e+="px";I.children("dl").eq(b).css({position:"absolute",top:c,left:e,display:"block"})}}function br(){if(z==null)z=H.outerWidth()}function bq(){if(y==null)y=H.children("li:first").outerHeight()}function bp(){if(w==null)w=G.outerHeight()}function bo(){if(x==null){x=(H.outerHeight()-H.height())/2}}function bn(){H.children("li:first-child").addClass(d.select_class);bs(H.children("li:first-child"))}function bm(){if(t){T(true);t=false}F.hide();C.removeClass(d.container_open_class);I.children("dl").hide();W();N()}function bl(){g=setTimeout(function(){if(f==false&&r==false){bm()}},500)}function bk(){var a=bh();if(a){bs(a.prev());a.removeClass(d.select_class).prev().addClass(d.select_class)}else{bs(H.children("li:last-child"),H.children("li").length-1);H.children("li:last-child").addClass(d.select_class)}T()}function bj(){var a=bh();if(a){bs(a.next());a.removeClass(d.select_class).next().addClass(d.select_class)}else{bs(H.children("li:first-child"),0);H.children("li:first-child").addClass(d.select_class)}T()}function bi(c){T(true);var e=bh();if(e){a(b).val(e.text());if(d.sub_info)a(b).attr("sub_info",e.attr("sub_info"));bm();v=a(b).val();if(d.select_only){J.val(e.attr("id"));N()}}if(d.bind_to){a(b).trigger(d.bind_to,c)}a(b).focus();a(b).change()}function bh(){if(!F.is(":visible"))return false;var a=H.children("li."+d.select_class);if(!a.length)a=false;return a}function bg(b,c,e){if(b.length==0){bm();return}H.empty();I.empty();for(var f=0;f<b.length;f++){var h=a("<li>").text(b[f]);if(d.select_only){h.attr("id",e[f])}H.append(h);if(c){var i="{";var j=a("<dl>");for(var k=0;k<c[f].length;k++){var l=c[f][k][0].replace("'","\\'");var m=c[f][k][1].replace("'","\\'");i+="'"+l+"':"+"'"+m+"'";if(k+1<c[f].length)i+=",";if(d.sub_as[c[f][k][0]]!=null){var n=d.sub_as[c[f][k][0]]}else{var n=c[f][k][0]}n=a("<dt>").text(n);j.append(n);var o=a("<dd>").text(c[f][k][1]);j.append(o)}i+="}";h.attr("sub_info",i);I.append(j);I.children("dl").hide()}}if(c)I.insertAfter(H);var p=C.offset();F.show().width(C.width()-(C.outerWidth()-C.innerWidth()));C.addClass(d.container_open_class);H.children("li").mouseover(function(){if(u){u=false;return}bs(this);H.children("li").removeClass(d.select_class);a(this).addClass(d.select_class)}).mousedown(function(a){r=true;clearTimeout(g)}).mouseup(function(a){r=false;if(u){u=false;return}a.preventDefault();a.stopPropagation();bi(false)});O()}function bf(){if(!k){if(l<n){l=n;X()}}else{if(m<o){m=o;X()}}}function be(){if(!k){if(l<n){l++;X()}}else{if(m<o){m++;X()}}}function bd(){if(!k){if(l>1){l--;X()}}else{if(m>1){m--;X()}}}function bc(){if(!k){if(l>1){l=1;X()}}else{if(m>1){m=1;X()}}}function bb(c,f,g){var h=d.per_page*(g-1)+1;var j=h+f-1;var p=e["page_info"].replace("cnt",c).replace("num_page_top",h).replace("num_page_end",j);G.text(p);var q=a("<p></p>");var r=Math.ceil(c/d.per_page);if(k){o=r}else{n=r}var s=g-Math.ceil((d.navi_num-1)/2);var t=g+Math.floor((d.navi_num-1)/2);while(s<1){s++;t++}while(t>r){t--}while(t-s<d.navi_num-1&&s>1){s--}if(g==1){if(!d.navi_simple){a("<span></span>").text("<< 1").addClass("page_end").appendTo(q)}a("<span></span>").text(e["prev"]).addClass("page_end").appendTo(q)}else{if(!d.navi_simple){a("<a></a>").attr({href:"javascript:void(0)","class":"navi_first"}).text("<< 1").attr("title",e["first_title"]).appendTo(q)}a("<a></a>").attr({href:"javascript:void(0)","class":"navi_prev"}).text(e["prev"]).attr("title",e["prev_title"]).appendTo(q)}for(i=s;i<=t;i++){var u=i==g?'<span class="current">'+i+"</span>":i;a("<a></a>").attr({href:"javascript:void(0)","class":"navi_page"}).html(u).appendTo(q)}if(g==r){a("<span></span>").text(e["next"]).addClass("page_end").appendTo(q);if(!d.navi_simple){a("<span></span>").text(r+" >>").addClass("page_end").appendTo(q)}}else{a("<a></a>").attr({href:"javascript:void(0)","class":"navi_next"}).text(e["next"]).attr("title",e["next_title"]).appendTo(q);if(!d.navi_simple){a("<a></a>").attr({href:"javascript:void(0)","class":"navi_last"}).text(r+" >>").attr("title",e["last_title"]).appendTo(q)}}if(r>1){G.append(q).show();a(".navi_first").mouseup(function(c){a(b).focus();c.preventDefault();bc()});a(".navi_prev").mouseup(function(c){a(b).focus();c.preventDefault();bd()});a(".navi_page").mouseup(function(c){a(b).focus();c.preventDefault();if(!k){l=parseInt(a(this).text(),10)}else{m=parseInt(a(this).text(),10)}X()});a(".navi_next").mouseup(function(c){a(b).focus();c.preventDefault();be()});a(".navi_last").mouseup(function(c){a(b).focus();c.preventDefault();bf()})}}function ba(b,c,e,f){if(!b.candidate){bm()}else{if(b.cnt>b.cnt_page){bb(b.cnt,b.cnt_page,e)}else{G.css("display","none")}var g=b.candidate;var h=[];if(b.attached&&d.sub_info){a.each(b.attached,function(a,b){h[a]=b})}else{h=false}var i=[];if(b.primary_key){a.each(b.primary_key,function(a,b){i[a]=b})}else{i=false}bg(g,h,i)}S();if(!f)bn()}function _(a,b){return b[d.order_field].localeCompare(a[d.order_field])}function Z(a,b){return a[d.order_field].localeCompare(b[d.order_field])}function Y(b,c,e){var f=b.replace(/\W/g,"\\$&");f=f.toString();var g=[];var h=new RegExp(f,"gi");for(var i in d.source){if(d.source[i][d.field].match(h))g.push(d.source[i])}var j={};j["cnt"]=g.length;if(!j["cnt"]){j["candidate"]=false}else{var k=[];var l=[];var m=[];var n=new RegExp("^"+f+"$","gi");var o=new RegExp("^"+f,"gi");for(var i in g){if(g[i][d.order_field].match(n)){k.push(g[i])}else if(g[i][d.order_field].match(o)){l.push(g[i])}else{m.push(g[i])}}if(d.order_by=="ASC"){k.sort(Z);l.sort(Z);m.sort(Z)}else{k.sort(_);l.sort(_);m.sort(_)}var p=k.concat(l);p=p.concat(m);var q=(c-1)*d.per_page;var r=q+d.per_page;var s=d.show_field.split(",");var t=d.hide_field.split(",");for(var u=q,v=0;u<r;u++,v++){if(p[u]==undefined)break;for(var w in p[u]){if(w==B){if(j["primary_key"]==undefined){j["primary_key"]=[]}j["primary_key"].push(p[u][w])}if(w==d.field){if(j["candidate"]==undefined){j["candidate"]=[]}j["candidate"].push(p[u][w])}else{if(a.inArray(w,t)==-1){if(s!==false&&!a.inArray("*",s)>-1&&!a.inArray(w,s)){continue}if(j["attached"]==undefined){j["attached"]=[]}if(j["attached"][v]==undefined){j["attached"][v]=[]}j["attached"][v].push([w,p[u][w]])}}}}j["cnt_page"]=j["candidate"].length}ba(j,b,c,e)}function X(){var c=arguments[0]==undefined?false:true;var e=k?a.trim(a(b).val()):"";var f=k?m:l;if(k&&e.length<d.minchars){bm()}else{W();I.children("dl").hide();R();if(typeof d.source=="object"){Y(e,f,c)}else{s=a.getJSON(d.source,{q_word:e,page_num:f,per_page:d.per_page,field:d.field,search_field:d.search_field,and_or:d.and_or,show_field:d.show_field,hide_field:d.hide_field,select_field:A,order_field:d.order_field,order_by:d.order_by,primary_key:B,db_table:d.db_table},function(a){ba(a,e,f,c)})}}}function W(){if(s){s.abort();s=false;S()}}function V(a){if(/27$|38$|40$|^9$/.test(a.keyCode)&&F.is(":visible")||/^37$|39$|13$|^9$/.test(a.keyCode)&&bh()||/40$/.test(a.keyCode)){if(a.preventDefault)a.preventDefault();if(a.stopPropagation)a.stopPropagation();a.cancelBubble=true;a.returnValue=false;switch(a.keyCode){case 37:if(a.shiftKey)bc();else bd();break;case 38:u=true;bk();break;case 39:if(a.shiftKey)bf();else be();break;case 40:if(!F.is(":visible")&&!bh()){k=false;X()}else{u=true;bj()}break;case 9:t=true;bm();break;case 13:bi(true);break;case 27:t=true;bm();break}}else{U()}}function U(){function c(){now_value=a(b).val();if(now_value!=v){a(b).removeAttr("sub_info");if(d.select_only){J.val("");N()}m=1;k=true;X(true)}v=now_value;U()}j=setTimeout(c,500)}function T(a){var b=bh();var c=b&&!a?b.offset().top:C.offset().top;var e;if(d.sub_info){e=I.height()+parseInt(I.css("border-top-width"),10)+parseInt(I.css("border-bottom-width"),10)}else{bq();e=y}var f=document.documentElement.clientHeight;var g=document.documentElement.scrollTop>0?document.documentElement.scrollTop:document.body.scrollTop;var h=g+f-e;var i;if(b.length){if(c<g||e>f){i=c-g}else if(c>h){i=c-h}else{return}}else if(c<g){i=c-g}window.scrollBy(0,i)}function S(){E.attr("src",d.button_img);p=false;if(q)D.mouseover();else D.mouseout()}function R(){p=true;P()}function Q(){var a=D.innerWidth();var b=D.innerHeight();var c=E.width();var d=E.height();var e=a/2-c/2;var f=b/2-d/2;E.css({top:f,left:e})}function P(){D.attr("title",e["loading"]);E.attr("src",d.load_img);Q()}function O(){D.attr("title",e["close_btn"]);E.attr("src",d.load_img);Q()}function N(){if(d.select_only){if(a(b).val()!=""){if(J.val()!=""){a(b).attr("title",e["select_ok"]).removeClass(d.select_ng_class).addClass(d.select_ok_class)}else{a(b).attr("title",e["select_ng"]).removeClass(d.select_ok_class).addClass(d.select_ng_class)}}else{J.val("")}}D.attr("title",e["get_all_btn"]);E.attr("src",d.button_img);Q()}function M(c){a(b).val(c);v=c;a(b).attr("title",e["select_ok"]).removeClass(d.select_ng_class).addClass(d.select_ok_class)}function L(a){for(var b=0;b<d.source.length;b++){if(d.source[b][d.primary_key]==a){var c=d.source[b][d.field];break}}M(c)}function K(){if(d.init_val===false)return;if(d.select_only){var c=d.init_val;J.val(c);var e="";if(typeof d.source=="object"){L(c)}else{var f=a.get(d.init_src,{q_word:c,field:d.field,primary_key:d.primary_key,db_table:d.db_table},function(a){M(a)})}}else{v=d.init_val;a(b).val(d.init_val)}}a.ajaxSetup({cache:false});var f=false;var g=false;var h=false;var j=false;var k=false;var l=1;var m=1;var n=1;var o=1;var p=false;var q=false;var r=false;var s=false;var t=false;var u=false;var v="";var w=null;var x=null;var y=null;var z=null;var A;if(d.sub_info){if(d.show_field&&!d.hide_field){A=d.field+","+d.show_field}else{A="*"}}else{A=d.field;d.hide_field=""}if(d.select_only&&A!="*"){A+=","+d.primary_key}var B=d.select_only?d.primary_key:"";a(b).attr("autocomplete","off").addClass(d.input_class).wrap("<div>");var C=a(b).parent().addClass(d.container_class);var D=a("<div>").addClass(d.button_class);var E=a("<img>").attr("src",d.button_img);C.append(D);D.append(E);C.append('<div style="clear:left"></div>');var F=a("<div></div>").addClass(d.re_area_class);var G=a("<div></div>").addClass(d.navi_class);var H=a("<ul></ul>").addClass(d.results_class);F.append(G).append(H);C.after(F);var I=a("<div></div>").addClass(d.sub_info_class);var J=a('<input type="hidden" />').attr({name:a(b).attr("name"),id:a(b).attr("name")+"_hidden"}).val("");if(d.select_only)C.append(J);C.width(a(b).outerWidth()+D.outerWidth());D.height(a(b).innerHeight());N();Q();K();D.mouseup(function(c){if(F.css("display")=="none"){clearInterval(j);k=false;X();a(b).focus()}else{bm()}c.stopPropagation()});D.mouseover(function(){q=true;if(p)return;D.addClass(d.btn_on_class).removeClass(d.btn_out_class)});D.mouseout(function(){q=false;if(p)return;D.addClass(d.btn_out_class).removeClass(d.btn_on_class)});D.mouseout();if(window.opera){a(b).keypress(V)}else{a(b).keydown(V)}a(b).focus(function(){f=true;U()});a(b).blur(function(a){clearTimeout(j);f=false;bl();N()});a(b).mousedown(function(a){r=true;clearTimeout(g);a.stopPropagation()});a(b).mouseup(function(c){a(b).focus();r=false;c.stopPropagation()});G.mousedown(function(a){r=true;clearTimeout(g);a.stopPropagation()});G.mouseup(function(c){a(b).focus();r=false;c.stopPropagation()});I.mousedown(function(a){r=true;clearTimeout(g);a.stopPropagation()});I.mouseup(function(c){a(b).focus();r=false;c.stopPropagation()});a("body").mouseup(function(){clearTimeout(g);f=false;bm()})};a.fn.ajaxComboBox=function(b,c){if(!b)return;c=a.extend({source:b,db_table:"tbl",img_dir:"acbox/img/",field:"name",and_or:"AND",minchars:1,per_page:10,navi_num:5,navi_simple:false,init_val:false,init_src:"acbox/php/initval.php",lang:"ja",bind_to:false,sub_info:false,sub_as:{},show_field:"",hide_field:"",select_only:false,primary_key:"id",container_class:"ac_container",input_class:"ac_input",button_class:"ac_button",btn_on_class:"ac_btn_on",btn_out_class:"ac_btn_out",re_area_class:"ac_result_area",navi_class:"ac_navi",results_class:"ac_results",select_class:"ac_over",match_class:"ac_match",sub_info_class:"ac_attached",select_ok_class:"ac_select_ok",select_ng_class:"ac_select_ng",container_open_class:"ac_container_open"},c);c=a.extend({search_field:c.field,order_field:c.field,order_by:"ASC",button_img:c.img_dir+"combobox_button"+".png",load_img:c.img_dir+"ajax-loader"+".gif"},c);switch(c.lang){case"ja":var d={add_btn:"è¿½åŠ ãƒœã‚¿ãƒ³",add_title:"å…¥åŠ›ãƒœãƒƒã‚¯ã‚¹ã‚’è¿½åŠ ã�—ã�¾ã�™",del_btn:"å‰Šé™¤ãƒœã‚¿ãƒ³",del_title:"å…¥åŠ›ãƒœãƒƒã‚¯ã‚¹ã‚’å‰Šé™¤ã�—ã�¾ã�™",next:"æ¬¡ã�¸",next_title:"æ¬¡ã�®"+c.per_page+"ä»¶ (å�³ã‚­ãƒ¼)",prev:"å‰�ã�¸",prev_title:"å‰�ã�®"+c.per_page+"ä»¶ (å·¦ã‚­ãƒ¼)",first_title:"æœ€åˆ�ã�®ãƒšãƒ¼ã‚¸ã�¸ (Shift + å·¦ã‚­ãƒ¼)",last_title:"æœ€å¾Œã�®ãƒšãƒ¼ã‚¸ã�¸ (Shift + å�³ã‚­ãƒ¼)",get_all_btn:"å…¨ä»¶å�–å¾— (ä¸‹ã‚­ãƒ¼)",get_all_alt:"ç”»åƒ�:ãƒœã‚¿ãƒ³",close_btn:"é–‰ã�˜ã‚‹ (Tabã‚­ãƒ¼)",close_alt:"ç”»åƒ�:ãƒœã‚¿ãƒ³",loading:"ãƒ­ãƒ¼ãƒ‰ä¸­...",loading_alt:"ç”»åƒ�:ãƒ­ãƒ¼ãƒ‰ä¸­...",page_info:"num_page_top - num_page_end ä»¶ (å…¨ cnt ä»¶)",select_ng:"æ³¨æ„� : ãƒªã‚¹ãƒˆã�®ä¸­ã�‹ã‚‰é�¸æŠžã�—ã�¦ã��ã� ã�•ã�„",select_ok:"OK : æ­£ã�—ã��é�¸æŠžã�•ã‚Œã�¾ã�—ã�Ÿã€‚"};break;case"en":var d={add_btn:"Add button",add_title:"add a box",del_btn:"Del button",del_title:"delete a box",next:"Next",next_title:"Next"+c.per_page+" (Right key)",prev:"Prev",prev_title:"Prev"+c.per_page+" (Left key)",first_title:"First (Shift + Left key)",last_title:"Last (Shift + Right key)",get_all_btn:"Get All (Down key)",get_all_alt:"(button)",close_btn:"Close (Tab key)",close_alt:"(button)",loading:"loading...",loading_alt:"(loading)",page_info:"num_page_top - num_page_end of cnt",select_ng:"Attention : Please choose from among the list.",select_ok:"OK : Correctly selected."};break;case"it":var d={add_btn:"Aggiungu",add_title:"Aggiungi",del_btn:"Togli",del_title:"Togli",next:">",next_title:"Prossimi "+c.per_page+" (Tasto destra)",prev:"<",prev_title:"Precedenti "+c.per_page+" (Tasto sinista)",first_title:"Primo (Shift + Tasto sinistra)",last_title:"Ultimo (Shift + Tasto destra)",get_all_btn:"Tutti (Tasto giù)",get_all_alt:"(giù)",close_btn:"Chiudi (Tab)",close_alt:"(chiudi)",loading:"caricamento...",loading_alt:"(caricamento)",page_info:"num_page_top - num_page_end of cnt",select_ng:"Attenzione : Scegliere un elemento dalla lista",select_ok:"OK : Selezione corretta."};break;case"es":var d={add_btn:"Agregar boton",add_title:"Agregar una opcion",del_btn:"Borrar boton",del_title:"Borrar una opcion",next:"Siguiente",next_title:"Proximas "+c.per_page+" (tecla derecha)",prev:"Anterior",prev_title:"Anteriores "+c.per_page+" (tecla izquierda)",first_title:"Primera (Shift + Left)",last_title:"Ultima (Shift + Right)",get_all_btn:"Ver todos (tecla abajo)",get_all_alt:"(boton)",close_btn:"Cerrar (tecla TAB)",close_alt:"(boton)",loading:"Cargando...",loading_alt:"(Cargando)",page_info:"num_page_top - num_page_end de cnt",select_ng:"Atencion: Elija una opcion de la lista.",select_ok:"OK: Correctamente seleccionado."};break;default:}this.each(function(){new a.ajaxComboBox(this,b,c,d)});return this}})(jQuery)
<style> 
label.error { float: none; color: red; padding-left: .5em; vertical-align: top; }
.ui-button { margin-left: -1px; }
.ui-button-icon-only .ui-button-text { padding: 0.35em; } 
.ui-autocomplete-input { margin: 0; padding: 0.48em 0 0.47em 0.45em; }
</style> 
<link href="/css/comments.css" rel="stylesheet" type="text/css" media="screen"/>
<link href="/css/jquery.taghandler.css" rel="stylesheet" type="text/css" media="screen"/>
<script type="text/javascript" src="/js/jquery.form.js"></script> 
<script type="text/javascript" src="/js/jquery.taghandler.js"></script> 
<script type="text/javascript" src="/js/comments.js"></script> 
<script src="/js/jform.js" type="text/javascript"></script>
<script type="text/javascript" src="/js/tiny_mce/jquery.tinymce.js"></script>
<script type="text/javascript"> 

var query = "";
var offset = 1;

// wait for the DOM to be loaded 
$(document).ready(function() { 
    // bind 'myForm' and provide a simple callback function 
    $('textarea').autogrow();
    //$("#new-msg-form").validate();
    $('#activity_list').load('/comments/load', function(){$('#e_act_more').bind( "click", function(){moreactivities();} );});
    
    $('#form_filter').ajaxForm({ beforeSubmit: function(data) { 
      query = $.param(data);
      offset = 1;
      $('#activity_list').text('');
      $('#activity_list').load('/comments/load?'+query); return false;}
    });
    
    $('#e_message').tinymce({
     // Location of TinyMCE script
     script_url : '/js/tiny_mce/tiny_mce.js',     
     // General options
     width : "530",
     content_css : "/js/tiny_mce/themes/advanced/skins/default/custom_content.css",
     theme_advanced_font_sizes: "10px,12px,13px,14px,16px,18px,20px",
     font_size_style_values : "10px,12px,13px,14px,16px,18px,20px",  
     theme : "advanced",
     plugins : "autolink, autoresize", 
     theme_advanced_buttons1 : "bold,italic,underline,separator,strikethrough,bullist,numlist,undo,redo",
     theme_advanced_buttons2 : "",
     theme_advanced_buttons3 : "",			
     theme_advanced_toolbar_location : "top",
     theme_advanced_toolbar_align : "left",
     theme_advanced_toolbar_align : "left",
     theme_advanced_resizing : false     
    });
}); 


var ulmsg=false;

function closeAlert() {
  if(ulmsg) {
    if( confirm("Attenzione, la pagina contiene dati non salvati, uscire comunque ?") ) {
      ulmsg=false;  
      return true;
    } else {
      return false;
    }
  }
}

function closedialog() {
  cleardirty();
  $('#new-data').dialog('close');
}

function cleardirty() {
  ulmsg=false;
}

function initForm() {
  ulmsg=true;
  $('#new-data').find("[title]").tooltip({"delay":1000});  
  $("#item_tags_handler").tagHandler({
      getData: { 'msg': "" },
      getURL: '/comments/gettags',            
      autocomplete: true
  }); 
 $('#new-data').find( "[type='radio']" ).button();
 $('#new-data').find('.radio-group > label').radioGroup();
 $('#new-data').find('.btn.toggle').toggleBtn();
}

window.onbeforeunload = closeAlert;

function opennewmsg() {  
  if($('#new-msg').is(':visible') ) {
    $('#act_last').val($('ul.activity_list > li').attr('id').substring('activity_'.length));
    $('#new-msg').slideUp();
  } else {     
    $('#act_last').val($('ul.activity_list > li').attr('id').substring('activity_'.length));
    $('#new-msg-form').ajaxForm({clearForm: true, success: function(data) { 	
      $('#activity_list').prepend(data);
      //$('#act_last').val($('ul.activity_list > li').attr('id').substring('activity_'.length));
    }, beforeSubmit: function(arr,$form) {     
      $("[name='tags']").attr('value','');
      tags = $("#message_tags_handler").tagHandler("getTags")
      for(tag in tags) {
	arr.push({name: "tags", value: tags[tag]});
      }
      $('#new-msg').slideUp();
    }}); 
    $("#message_tags_handler").tagHandler({
	getData: { 'msg': "" },
	getURL: '/comments/gettags',            
	autocomplete: true
    });
    $('#new-msg').slideDown();  
  }
}

function opennewwiz(url) {
  $('#new-data-form').load(url, function(){
    initForm();
    $('#act_last').val($('ul.activity_list > li').attr('id').substring('activity_'.length)); 
    $("#form0").formwizard({ 
      formPluginEnabled: true,
      validationEnabled: true,
      validationOptions: {
	errorClass: "error",
	errorPlacement: function(error, element) {	
	  //error.appendTo( element.parent().parent() );
	  //alert(error.text());
	  $($($(element).parent()).parent()).attr("title", error.text());
	  $($($(element).parent()).parent()).twipsy({title:'data-original-title', trigger:'manual'});
	  $($($(element).parent()).parent()).twipsy('show');
        },
	highlight: function(element, errorClass, validClass) {
	    $($($(element).parent()).parent()).twipsy('show');
	    //alert("pippo");
	    //$($($($($(element).parent()).parent()).parent()).parent()).addClass(errorClass).removeClass(validClass);
	 },
	unhighlight: function(element, errorClass, validClass) {
	    $($($(element).parent()).parent()).twipsy('hide');
	    //alert("pappo");	
	    //$($($($($(element).parent()).parent()).parent()).parent()).addClass(validClass).removeClass(errorClass);
	 }
      },
      focusFirstInput : true,
      textNext: "Avanti",
      textBack: "Indietro",
      disableUIStyles: true,
      remoteAjax : {"step1" : { // add a remote ajax call when moving next from the second step
	url : url + "val", 
	dataType : 'text',
	//beforeSend : function(){alert("Starting validation.")},
	//complete : function(){alert("Validation complete.")},
	success : function(data){
	  if(data != "Ok") {
	    $("#formwiz-error").append(data);
	    $('#formwiz-error').dialog({ modal: true, width: "40em", zIndex: 3, autoOpen: false,  buttons: [
	      { text: "Ok",
		click: function() { $(this).dialog("close"); $('#formwiz-error').text(''); } } ] });
	    $('#formwiz-error').dialog('open');	    
	    return false; //return false to stop the wizard from going forward to the next step (this will always happen)
	  }
	  return true; //return true to make the wizard move to the next step
	}
      }},      
      formOptions :{
	// on new form submit
	success: function(data){
	  $('#new-data-preview').html(data);
	  if($('#form-error').html()) {
	    $('#form-error').dialog({ modal: true, width: "40em", zIndex: 3, autoOpen: false,  buttons: [
	      { text: "Ok",
		click: function() { $('#form-error').detach(); $(this).dialog("close"); } } ] });
	    $('#form-error').dialog('open');
	    $('#new-data-preview').text('');
	  } else {
	    $('#act_last').clone().appendTo('#form1');
	    $('#new-data-form').hide();  
	    $('#new-data-preview').show();
	  }
	  // on preview form submit
	  $('#form1').ajaxForm(function(data) {
	    $('#new-data').dialog('close');
	    $('#new-data-form').text('');
	    $('#new-data-preview').text('');
	    $('#activity_list').prepend(data);
	    $('#new-nc').html("Inserire anche una Non conformit&agrave; ?")
	    $('#new-nc').dialog({ title: "Nuova Non conformità", modal: true, width: "40em", zIndex: 3, autoOpen: false,  buttons: [
	      { text: "Si",
		click: function() { $(this).dialog("close"); opennewnc(); } }, 
	      { text: "No",
	        click: function() { $(this).dialog("close"); } } ] });
	    $('#new-nc').dialog('open');
	    //$('#act_last').val($('ul.activity_list > li').attr('id').substring('activity_'.length));
	    //$('#act_last').clone().appendTo('#form1');
	  });
	},
	resetForm: false,
	beforeSubmit: function() {
	  $("[name='tags']").attr('value','');
          tags = $("#wiz_tags_handler").tagHandler("getTags")
          for(tag in tags) {
    	    arr.push({name: "tags", value: tags[tag]});
	  }
	}
      }
    });
    $.validator.messages = {
	number: "Inserire in numero",
	required: "Inserire o selezionare un valore",
	range: "Inserire un valore compreso tra {0} e {1}" };
    $("#form0").bind("step_shown", function(event, data){
      $("#formwiz-progress-" + data.previousStep).toggleClass("active");
      $("#formwiz-progress-" + data.currentStep).toggleClass("active");
    });
    $('#new-data').show();
    $('#new-data-form').show();
    $("#formwiz-progress-step1").toggleClass("active");
    $('#new-data').dialog({ title: $('#title').text(), modal: true, height: 600, width: 820, zIndex: 2, autoOpen: false, beforeClose: closeAlert, });
    $('#new-data').dialog('open');
  });
}

function onopennewitem() {
 initForm();
 
 $("#form0").validate({
   errorClass: "error",
   errorPlacement: function(error, element) {	
     //error.appendTo( element.parent().parent() );
     //alert(error.text());
     $($($(element).parent()).parent()).attr("title", error.text());
     $($($(element).parent()).parent()).twipsy({title:'data-original-title', trigger:'manual'});
     $($($(element).parent()).parent()).twipsy('show');
   },
   highlight: function(element, errorClass, validClass) {
       $($($(element).parent()).parent()).twipsy('show');
    },
   unhighlight: function(element, errorClass, validClass) {
       $($($(element).parent()).parent()).twipsy('hide');
    }
  });
  
  $('#form0').ajaxForm({clearForm: false, success: function(data) { 
    $('#new-data-preview').html(data);
    if(data.indexOf('form-error')>0) {
      $('#form-error').dialog({ modal: true, width: "40em", zIndex: 3, autoOpen: false,  buttons: [
	{ text: "Ok",
          click: function() { $('#form-error').detach(); $(this).dialog("close"); } } ] });
      $('#form-error').dialog('open');      
    } else {
      $('#new-data-form').hide();  
      $('#new-data-preview').show();
      $('#act_last').val($('ul.activity_list > li').attr('id').substring('activity_'.length));
      $('#act_last').clone().appendTo('#form1');
    }
    $('#form1').ajaxForm(function(data) {      
      $('#new-data').dialog('close');
      $('#new-data-form').text('');
      $('#new-data-preview').text('');
      $('#activity_list').prepend(data);
      $('#new-nc').html("Inserire altra Non conformit&agrave; ?")
      $('#new-nc').dialog({ title: "Nuova Non conformità", modal: true, width: "40em", zIndex: 3, autoOpen: false,  buttons: [
	{ text: "Si",
	  click: function() { $(this).dialog("close"); opennewnc(); } }, 
	{ text: "No",
	  click: function() { $(this).dialog("close"); } } ] });
      $('#new-nc').dialog('open');
      
    });
  }, beforeSubmit: function(arr,$form) {
    $("[name='tags']").attr('value','');
    tags = $("#item_tags_handler").tagHandler("getTags")
    for(tag in tags) {
      arr.push({name: "tags", value: tags[tag]});
    }
  }});
  $('textarea').autogrow();
  $.validator.messages = {
      required: "Inserire o selezionare un valore",
      range: "Inserire un valore compreso tra {0} e {1}" };
  $('#new-data').show();
  $('#new-data-form').show();
  $('#new-data').dialog({ title: $('#title').text(), modal: true, height: 550, width: 820, zIndex: 20000, autoOpen: false,  beforeClose: closeAlert});
  $('#new-data').dialog('open');
}

function onclosenewitem() {
  ulmsg=false;
  $('#new-data').dialog('close');
  //$('#new-data').html('');
  return false;
}

function opennewisp() {
 opennewwiz("/isp/isp");
}

function opennewnc() {
 $('#new-data-form').load("/isp/nc", onopennewitem);
}

function opennewdieta() {
  opennewwiz("/isp/dieta");
}

function opennewnota() {
 $('#new-data-form').load("/isp/nota", onopennewitem);
}

function previewback() {
 $('#new-data-preview').hide();
 $('#new-data-form').show();
}

function filteractivities(q) {
  if(q) {
    query = q;
  }
  offset=0;
  $.ajax({url:'/comments/load?'+query+'&offset='+offset, success: function(data){
    $('#activity_list').text('');
    $('#activity_list').append(data);    
    offset += 1;
  }}); 
}

function moreactivities() {
  $('#e_act_more').button('loading');
  $.ajax({url:'/comments/load?'+query+'&ease=1'+'&offset='+offset, success: function(data){
    $('#activity_list').append(data);
    offset += 1;
    $('#e_act_more').button('reset');
  }}); 
}

</script> 
{%set tab_activity="active"%}
{%include "navigation.html"%}
<div id="activities" class="activity_container">
{%if commissario or genitore%}
<div id="nav-priv-cnt"></div>
<div class="well">
<h3>Aggiungi nuovo:</h3>
<button class="btn primary" onclick="opennewmsg();">Messaggio</button>
<button class="btn primary" onclick="opennewisp();">Ispezione</button>
<button class="btn primary" onclick="opennewdieta();">Ispezione Diete</button>
<button class="btn primary" onclick="opennewnc();">Non conformit&agrave;</button>
<button class="btn primary" onclick="opennewnota();">Nota</button>
</div>
<div id="new-data" style="display:none;">
 <div id="new-data-form" style="border: none;"></div> 
 <div id="new-data-preview" style="display:none;"></div> 
</div> 
<div id="new-nc" style="display:none;"></div> 
{%endif%}
<div class="row">
  <div class="span9">
{%if commissario or genitore%}  
    <div id="new-msg" style="display:none;">
     <form id="new-msg-form" action="/comments/message" method="post" class="form-stacked" novalidate="true"> 
      <input type="hidden" id="act_last" name="last" value="" />  
      <input type="hidden" name="livello" value="0" />  
      <input type="hidden" name="tipo" value="201" /> 
      <div class="comment_avatar">
       <img src="{{user.avatar}}" title="{{user.fullname}}">
      </div>
      <div class="comment_body">
       <div class="comment_author">{{user.fullname}}</div>
       <div class="comment_author_title"></div>       
       <div class="comment_text">
	<div class="clearfix">
	 <label>Titolo:</label>
	 <div class="input">
	  <input type="text" class="xxlarge" name="titolo">
	 </div>
	 <label>Testo:</label>
	 <div class="input">
    	  <textarea cols="80" rows="4" class="xxlarge comment_textarea required" name="testo" id="e_message"></textarea>
	 </div>
	 <label>Categorie:</label>	 
	 <div class="input">  	  
	  <ul id="message_tags_handler"></ul>
	 </div>
	</div>
	<div class="actions">
	 <button class="btn primary" type="submit">Invia</button>
	 <button class="btn" type="reset" onclick="opennewmsg();">Annulla</button>
	</div>
       </div>  
     </form>
    </div>
   </div>     
{%endif%}
    <ul class="activity_list" id="activity_list"></ul>
  </div>
  <div class="span3">
    <h4>Scuole</h4>
      {%if commissario or genitore%}{%for cm in cmsro.commissioni() %}<div><a href="#" onclick="filteractivities('cm={{cm.key.id()}}')">{{cm.desc()}}</a></div>
      {%endfor%}{%endif%}
    <h4>Tipo dati</h4>
      <div><a href="#"  onclick="filteractivities('user=!&type=!&tag=!')">Tutto</a></div>
      <div class="divider"></div>{%if commissario or genitore%}
      <div><a href="#" onclick="filteractivities('user={{user.email()}}')">Inseriti da me</a></div>
      <div class="divider"></div>{%endif%}
      <div><a href="#" onclick="filteractivities('type=201')">Messaggi</a></div>
      <div><a href="#" onclick="filteractivities('type=101')">Ispezioni</a></div>
      <div><a href="#" onclick="filteractivities('type=102')">Ispezioni Diete</a></div>
      <div><a href="#" onclick="filteractivities('type=103')">Non conformit&agrave;</a></div>
      <div><a href="#" onclick="filteractivities('type=104')">Note</a></div>    
    <h4>Categorie</h4>
    <ul class="">
      {%for tag in tags%}<li><a href="#" onclick="filteractivities('tag={{tag.nome}}')">{{tag.nome}}</a></li>
      {%endfor%}
    </ul>    
  </div>  
</div>
  <div class="span9" style="text-align:center"><button data-loading-text="caricamento in corso..." class="btn span6" id="e_act_more">Carica altri...</button></div>    
</div>
